#include <WiFi.h>
#include <WebServer.h>

// Pin Definitions
#define TRIG 13
#define ECHO 12
#define LED1 14
#define LED2 27
#define LED3 26
#define LED4 25
#define LED5 33 // Red LED

WebServer server(80);
float distance = 0;

void handleRoot() {
  String html = "<html><head><meta name='viewport' content='width=device-width, initial-scale=1.0'>";
  html += "<style>";
  html += "body { background-color: #121212; color: white; font-family: sans-serif; text-align: center; padding: 20px; }";
  html += ".calligraphy { font-family: 'Lucida Calligraphy', 'cursive'; color: #FFF44F; font-size: 2.5em; margin-bottom: 5px; }"; 
  html += ".header { color: #FFF44F; font-size: 1.5em; text-transform: uppercase; letter-spacing: 2px; }";
  html += ".reading { font-size: 80px; font-weight: bold; margin: 30px 0; color: #00FF00; }";
  html += ".container { border: 2px solid #FFF44F; border-radius: 15px; padding: 20px; display: inline-block; background: #1e1e1e; }";
  html += "</style></head><body>";
  
  html += "<div class='calligraphy'>Ashwath H</div>";
  html += "<div class='header'>Distance Measurement Hub</div>";
  
  html += "<div class='container'>";
  html += "<div class='reading'>" + String(distance, 1) + " <span style='font-size:30px'>cm</span></div>";
  html += "<p>Precision Ultrasonic Monitoring Active</p>";
  html += "</div>";

  html += "<script>setInterval(function(){location.reload();}, 500);</script>";
  html += "</body></html>";
  
  server.send(200, "text/html", html);
}

void setup() {
  Serial.begin(115200);
  
  pinMode(TRIG, OUTPUT);
  pinMode(ECHO, INPUT);
  pinMode(LED1, OUTPUT); pinMode(LED2, OUTPUT);
  pinMode(LED3, OUTPUT); pinMode(LED4, OUTPUT);
  pinMode(LED5, OUTPUT);

  // Set AP Credentials
  WiFi.softAP("ESP32", "Ashwath H");
  
  server.on("/", handleRoot);
  server.begin();
}

void loop() {
  server.handleClient();

  // 1. Precise Ultrasonic Measurement
  digitalWrite(TRIG, LOW);
  delayMicroseconds(2);
  digitalWrite(TRIG, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG, LOW);
  
  long duration = pulseIn(ECHO, HIGH, 30000); // 30ms timeout
  distance = (duration * 0.0343) / 2;

  // 2. Exact LED Logic (Bar Graph Style)
  digitalWrite(LED1, (distance < 50 && distance > 0) ? HIGH : LOW);
  digitalWrite(LED2, (distance < 40 && distance > 0) ? HIGH : LOW);
  digitalWrite(LED3, (distance < 30 && distance > 0) ? HIGH : LOW);
  digitalWrite(LED4, (distance < 20 && distance > 0) ? HIGH : LOW);
  digitalWrite(LED5, (distance < 10 && distance > 0) ? HIGH : LOW); // Red Alert

  delay(100); 
}
